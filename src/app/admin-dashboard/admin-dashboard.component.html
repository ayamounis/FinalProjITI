<div class="admin-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="container">
      <h1><i class="fas fa-cog"></i> Admin Dashboard</h1>
      <p>Manage users and product templates</p>
    </div>
  </div>

  <!-- Body with Sidebar + Main -->
  <div class="dashboard-body">
    <div class="container">
      <div class="dashboard-layout">
        <!-- Sidebar (Vertical Nav) -->
        <aside class="sidebar">
          <div class="sidebar-header">
            <img src="img/logo_no_bg.png" alt="Artivio" />
            <div class="sidebar-brand">
              <span class="brand-name">Artivio</span>
              <span class="brand-sub">Admin</span>
            </div>
          </div>

        <button
            class="sidebar-tab"
          [class.active]="activeTab === 'users'"
          (click)="switchTab('users')"
        >
            <span class="tab-left">
          <i class="fas fa-users"></i>
              <span class="tab-label">Users Management</span>
            </span>
        </button>
        <button
            class="sidebar-tab"
          [class.active]="activeTab === 'templates'"
          (click)="switchTab('templates')"
        >
            <span class="tab-left">
          <i class="fas fa-box"></i>
              <span class="tab-label">Product Templates</span>
            </span>
        </button>
        <button
            class="sidebar-tab"
          [class.active]="activeTab === 'analytics'"
          (click)="switchTab('analytics')"
        >
            <span class="tab-left">
          <i class="fas fa-chart-bar"></i>
              <span class="tab-label">Analytics</span>
            </span>
        </button>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
      <!-- Loading Spinner -->
      @if (isLoading) {
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
      }

          <div class="main-container">
      <!-- Users Tab -->
      @if (activeTab === 'users' && !isLoading) {
      <div class="users-section">
        <!-- Search and Actions -->
        <div class="section-header">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              placeholder="Search users..."
              [(ngModel)]="userSearchTerm"
            />
          </div>
          <div class="section-actions">
            <span class="user-count">{{ filteredUsers.length }} users</span>
          </div>
        </div>

        <!-- Users Table -->
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (user of paginatedUsers; track user.id) {
              <tr>
                <td>
                  <div class="user-info">
                    <div class="user-avatar">
                      <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                      <span class="user-name"
                        >{{ user.firstName }} {{ user.lastName }}</span
                      >
                      <span class="user-id"
                        >ID: {{ user.id.substring(0, 8) }}...</span
                      >
                    </div>
                  </div>
                </td>
                <td>{{ user.email }}</td>
                <td>{{ user.phoneNumber || "N/A" }}</td>
                <td>
                  <span
                    class="status-badge"
                    [class.confirmed]="user.emailConfirmed"
                  >
                    {{ user.emailConfirmed ? "Confirmed" : "Pending" }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button
                      class="btn-edit"
                      (click)="openUserModal(user)"
                      title="Edit User"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    <button
                      class="btn-delete"
                      (click)="deleteUser(user)"
                      title="Delete User"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Users Pagination -->
        @if (totalUserPages > 1) {
        <div class="pagination-container">
          <div class="pagination-info">
            <span
              >Showing {{ (currentUserPage - 1) * itemsPerPage + 1 }} to
              {{
                Math.min(currentUserPage * itemsPerPage, filteredUsers.length)
              }}
              of {{ filteredUsers.length }} users</span
            >
          </div>
          <div class="pagination-controls">
            <button
              class="pagination-btn"
              [disabled]="currentUserPage === 1"
              (click)="goToUserPage(currentUserPage - 1)"
              title="Previous page"
            >
              <i class="fas fa-chevron-left"></i>
            </button>

            @for (page of getVisibleUserPages(); track page) { @if (page ===
            '...') {
            <span class="pagination-ellipsis">...</span>
            } @else {
            <button
              class="pagination-btn page-number"
              [class.active]="page === currentUserPage"
              (click)="goToUserPage(Number(page))"
            >
              {{ page }}
            </button>
            } }

            <button
              class="pagination-btn"
              [disabled]="currentUserPage === totalUserPages"
              (click)="goToUserPage(currentUserPage + 1)"
              title="Next page"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        }
      </div>
      }

      <!-- Templates Tab -->
      @if (activeTab === 'templates' && !isLoading) {
      <div class="templates-section">
        <!-- Search and Actions -->
        <div class="section-header">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              placeholder="Search templates..."
              [(ngModel)]="templateSearchTerm"
            />
          </div>
          <div class="section-actions">
            <button class="btn-primary" (click)="openTemplateModal()">
              <i class="fas fa-plus"></i>
              Add Template
            </button>
            <span class="template-count"
              >{{ filteredTemplates.length }} templates</span
            >
          </div>
        </div>

        <!-- Templates Grid -->
        <div class="templates-grid">
          @for (template of paginatedTemplates; track
          template.productTemplateId) {
          <div class="template-card">
            <div class="template-image">
              <img [src]="template.imageUrl" [alt]="template.name" />
              <div class="template-overlay">
                <button class="btn-edit" (click)="openTemplateModal(template)">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-delete" (click)="deleteTemplate(template)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="template-content">
              <h3>{{ template.name }}</h3>
              <p class="template-description">{{ template.description }}</p>
              <div class="template-meta">
                <span class="price">${{ template.basePrice }}</span>
                <span class="category">{{
                  getCategoryName(template.category)
                }}</span>
              </div>
              <div class="template-status">
                <span class="status-badge" [class.active]="template.isActive">
                  {{ template.isActive ? "Active" : "Inactive" }}
                </span>
                <span class="created-date">{{
                  formatDate(template.createdAt)
                }}</span>
              </div>
            </div>
          </div>
          }
        </div>

        <!-- Templates Pagination -->
        @if (totalTemplatePages > 1) {
        <div class="pagination-container">
          <div class="pagination-info">
            <span
              >Showing {{ (currentTemplatePage - 1) * itemsPerPage + 1 }} to
              {{
                Math.min(
                  currentTemplatePage * itemsPerPage,
                  filteredTemplates.length
                )
              }}
              of {{ filteredTemplates.length }} templates</span
            >
          </div>
          <div class="pagination-controls">
            <button
              class="pagination-btn"
              [disabled]="currentTemplatePage === 1"
              (click)="goToTemplatePage(currentTemplatePage - 1)"
              title="Previous page"
            >
              <i class="fas fa-chevron-left"></i>
            </button>

            @for (page of getVisibleTemplatePages(); track page) { @if (page ===
            '...') {
            <span class="pagination-ellipsis">...</span>
            } @else {
            <button
              class="pagination-btn page-number"
              [class.active]="page === currentTemplatePage"
              (click)="goToTemplatePage(Number(page))"
            >
              {{ page }}
            </button>
            } }

            <button
              class="pagination-btn"
              [disabled]="currentTemplatePage === totalTemplatePages"
              (click)="goToTemplatePage(currentTemplatePage + 1)"
              title="Next page"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        }
      </div>
      }

      <!-- Analytics Tab -->
      @if (activeTab === 'analytics' && !isLoading) {
      <div class="analytics-section">
        <!-- Analytics Overview -->
        <div class="analytics-overview">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
              <h3>{{ analytics?.totalUsers || 0 }}</h3>
              <p>Total Users</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-store"></i>
            </div>
            <div class="stat-content">
              <h3>{{ analytics?.totalSellers || 0 }}</h3>
              <p>Seller Profiles</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
              <h3>${{ (analytics?.totalRevenue || 0).toFixed(2) }}</h3>
              <p>Total Revenue</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-content">
              <h3>{{ analytics?.totalOrders || 0 }}</h3>
              <p>Total Orders</p>
            </div>
          </div>
        </div>

        <!-- Monthly Statistics -->
        @if (analytics && analytics.monthlyStats &&
        analytics.monthlyStats.length > 0) {
        <div class="monthly-stats">
          <h3>Monthly Statistics</h3>
          <div class="stats-table">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Revenue</th>
                  <th>Orders</th>
                  <th>New Users</th>
                  <th>New Sellers</th>
                </tr>
              </thead>
              <tbody>
                      @for (stat of analytics.monthlyStats || []; track stat.month) {
                <tr>
                  <td>{{ stat.month }}</td>
                  <td>${{ stat.revenue.toFixed(2) }}</td>
                  <td>{{ stat.orders }}</td>
                  <td>{{ stat.newUsers }}</td>
                  <td>{{ stat.newSellers }}</td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
        }

        <!-- Recent Activity -->
        @if (analytics && analytics.recentActivity &&
        analytics.recentActivity.length > 0) {
        <div class="recent-activity">
          <h3>Recent Activity</h3>
          <div class="activity-list">
                  @for (activity of analytics.recentActivity || []; track
            activity.id) {
            <div class="activity-item">
              <div class="activity-icon">
                @switch (activity.type) { @case ('user_registration') {
                <i class="fas fa-user-plus"></i>
                } @case ('seller_registration') {
                <i class="fas fa-store"></i>
                } @case ('order_placed') {
                <i class="fas fa-shopping-cart"></i>
                } @case ('payment_received') {
                <i class="fas fa-credit-card"></i>
                } }
              </div>
              <div class="activity-content">
                <p class="activity-description">{{ activity.description }}</p>
                <span class="activity-time">{{
                  formatDate(activity.timestamp)
                }}</span>
                @if (activity.amount) {
                <span class="activity-amount"
                  >${{ activity.amount.toFixed(2) }}</span
                >
                }
              </div>
            </div>
            }
          </div>
        </div>
        }

        <!-- Charts Section -->
        <div class="charts-section">
          <!-- Bar Chart -->
          <div class="chart-container">
            <h3>Platform Statistics</h3>
            <div class="bar-chart">
              <div class="chart-bars">
                <div class="bar-group">
                  <div
                    class="bar users-bar"
                    [ngStyle]="{'height': getUserBarHeightPx() + 'px'}"
                  >
                    <span class="bar-value">{{
                      analytics?.totalUsers || 0
                    }}</span>
                  </div>
                  <span class="bar-label">Users</span>
                </div>
                <div class="bar-group">
                  <div
                    class="bar sellers-bar"
                    [ngStyle]="{'height': getSellerBarHeightPx() + 'px'}"
                  >
                    <span class="bar-value">{{
                      analytics?.totalSellers || 0
                    }}</span>
                  </div>
                  <span class="bar-label">Sellers</span>
                </div>
                <div class="bar-group">
                  <div
                    class="bar revenue-bar"
                    [ngStyle]="{'height': getRevenueBarHeightPx() + 'px'}"
                  >
                    <span class="bar-value"
                      >${{ (analytics?.totalRevenue || 0).toFixed(0) }}</span
                    >
                  </div>
                  <span class="bar-label">Revenue</span>
                </div>
                <div class="bar-group">
                  <div
                    class="bar orders-bar"
                    [ngStyle]="{'height': getOrdersBarHeightPx() + 'px'}"
                  >
                    <span class="bar-value">{{
                      analytics?.totalOrders || 0
                    }}</span>
                  </div>
                  <span class="bar-label">Orders</span>
                </div>
              </div>
              <div class="chart-axis">
                <div class="y-axis">
                  <span>{{ getMaxCountValue() }}</span>
                  <span>{{ getMaxCountValue() * 0.75 }}</span>
                  <span>{{ getMaxCountValue() * 0.5 }}</span>
                  <span>{{ getMaxCountValue() * 0.25 }}</span>
                  <span>0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Pie Chart -->
          <div class="chart-container">
            <h3>Revenue Distribution</h3>
            <div class="pie-chart">
              <div class="pie-container">
                <div
                  class="pie-segment users-segment"
                  [style.transform]="
                    getPieSegmentTransform(0, getUserPercentage())
                  "
                >
                  <div class="segment-label">
                    Users: {{ getUserPercentage() }}%
                  </div>
                </div>
                <div
                  class="pie-segment sellers-segment"
                  [style.transform]="
                    getPieSegmentTransform(
                      getUserPercentage(),
                      getSellerPercentage()
                    )
                  "
                >
                  <div class="segment-label">
                    Sellers: {{ getSellerPercentage() }}%
                  </div>
                </div>
                <div
                  class="pie-segment revenue-segment"
                  [style.transform]="
                    getPieSegmentTransform(
                      getUserPercentage() + getSellerPercentage(),
                      getRevenuePercentage()
                    )
                  "
                >
                  <div class="segment-label">
                    Revenue: {{ getRevenuePercentage() }}%
                  </div>
                </div>
                <div class="pie-center">
                  <span class="center-label">Total</span>
                  <span class="center-value">{{ getTotalPieValue() }}</span>
                </div>
              </div>
              <div class="pie-legend">
                <div class="legend-item">
                  <div class="legend-color users-color"></div>
                  <span>Users</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color sellers-color"></div>
                  <span>Sellers</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color revenue-color"></div>
                  <span>Revenue</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      }
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  @if (showUserModal) {
  <div class="modal-overlay" (click)="closeUserModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditing ? "Edit User" : "Add User" }}</h3>
        <button class="modal-close" (click)="closeUserModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="userForm" (ngSubmit)="saveUser()">
          <div class="form-group">
            <label for="firstName">First Name</label>
            <input
              type="text"
              id="firstName"
              formControlName="firstName"
              placeholder="Enter first name"
            />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name</label>
            <input
              type="text"
              id="lastName"
              formControlName="lastName"
              placeholder="Enter last name"
            />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              placeholder="Enter email address"
            />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="closeUserModal()"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="!userForm.valid"
            >
              {{ isEditing ? "Update" : "Create" }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  <!-- Template Modal -->
  @if (showTemplateModal) {
  <div class="modal-overlay" (click)="closeTemplateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditing ? "Edit Template" : "Add Template" }}</h3>
        <button class="modal-close" (click)="closeTemplateModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="templateForm" (ngSubmit)="saveTemplate()">
          <div class="form-group">
            <label for="name">Template Name</label>
            <input
              type="text"
              id="name"
              formControlName="name"
              placeholder="Enter template name"
            />
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              id="description"
              formControlName="description"
              placeholder="Enter template description"
              rows="3"
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="basePrice">Base Price</label>
              <input
                type="number"
                id="basePrice"
                formControlName="basePrice"
                placeholder="0.00"
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="category">Category</label>
              <select id="category" formControlName="category">
                @for (category of categories; track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="imageUrl">Image URL</label>
            <input
              type="url"
              id="imageUrl"
              formControlName="imageUrl"
              placeholder="Enter image URL"
            />
          </div>
          <div class="form-group">
            <label for="elements">Elements (JSON)</label>
            <textarea
              id="elements"
              formControlName="elements"
              placeholder="Enter elements JSON"
              rows="4"
            ></textarea>
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="closeTemplateModal()"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="!templateForm.valid"
            >
              {{ isEditing ? "Update" : "Create" }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }
</div>
